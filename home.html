<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HERMES</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <!--<link type="text/css" rel="stylesheet" href="/main.css">-->
    <link rel="icon" type="image/png" href="/logo.png" />
</head>

<body>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <div class="container">

        <table>
            <thead>
                <tr>
                    <th>name</th>
                    <th>publicKey</th>
                </tr>
            </thead>
            <tbody id="users">

            </tbody>
        </table>

    </div>
    <a href="/logout">LOGOUT</a>
    <script type="text/javascript">
        const enc = new TextEncoder();
        const dec = new TextDecoder();

        async function generateKeyPair() {
            return await window.crypto.subtle.generateKey({
                name: "RSA-OAEP",
                modulusLength: 4096,
                publicExponent: new Uint8Array([1, 0, 1]),
                hash: "SHA-256"
            },
                true,
                ["encrypt", "decrypt"]
            );
        }

        async function encryptMessage(msg, publicKey) {
            return await window.crypto.subtle.encrypt({
                name: "RSA-OAEP"
            },
                publicKey,
                enc.encode(msg)
            )
        }

        async function decryptMessage(msg, privateKey) {
            let decryptedMessage = await window.crypto.subtle.decrypt({
                name: "RSA-OAEP"
            },
                privateKey,
                msg
            );
            return dec.decode(decryptedMessage);
        }

        async function s() {

            console.log("dsqdqs");

            const {
                PRIVATE_KEY,
                PUBLIC_KEY
            } = await generateKeyPair();

            const name = sessionStorage.getItem("name");
            const token = sessionStorage.getItem("token");

            console.log("Vous êtes : " + name + " / " + token);

            let socket = io();

            socket.emit("receiveInfos", {
                name:name,
                token:token,
                key:PUBLIC_KEY
            });
        }

        s();

        $('#form').on('submit', (e) => {
            e.preventDefault();
            /*let messageOriginal = $("#login").val();
            console.log("original : " + messageOriginal);
          
            const {
                privateKey,
                publicKey
            } = await generateKeyPair();
          
            let encryptedMessage = await encryptMessage(messageOriginal, publicKey);
          
            let uintArray = new Uint8Array(encryptedMessage);
          
            let string = String.fromCharCode.apply(null, uintArray);
          
            let base64Data = btoa(string);
          
            console.log("encodé : " + base64Data);
          
            let decryptedMessage = await decryptMessage(encryptedMessage, privateKey);
            
            console.log(decryptedMessage);*/

            console.log("trying");

            let login = $('#login').val();
            let password = $('#password').val();
            console.log(login + " " + password);
            socket.emit('login', {
                login: login,
                password: password
            });
            $("#login").html("");
            $("#password").html("");
        });

        /*/socket.on('users', (users) => {
            let $users = $("#users");
            $users.html("");
            console.log("récupération des utilisateurs");
            users.forEach(user => {
                console.log(user);
                let $line = $("<tr>");
                let $name = $("<td>").html(user.name);
                $name.appendTo($line);
                let $publicKey = $("<td>").html(user.publicKey);
                $publicKey.appendTo($line);
                $line.appendTo($users);
            });
        });*/

        /*socket.on('login response', function (logged) {
            if (logged) {
                console.log("connecté !");
                sessionStorage.setItem("socket", socket);
                window.location.replace("/accueil.html");
            }
        });*/
    </script>
</body>

</html>